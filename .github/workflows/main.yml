name: 2048 AI CPU Benchmark

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´åˆå¤œè¿è¡Œä¸€æ¬¡
    - cron: '0 0 * * *'

env:
  BUILD_TYPE: Release

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run-type: [benchmark, visual]
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ› ï¸ Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y g++-11
        echo "CXX=g++-11" >> $GITHUB_ENV
    
    - name: ğŸ”¨ Build 2048 AI
      run: |
        chmod +x build.sh
        ./build.sh
    
    - name: ğŸ“Š Run AI Benchmark
      if: matrix.run-type == 'benchmark'
      run: |
        echo "ğŸ§ª Starting AI Benchmark..."
        time timeout 300 ./2048_ai || echo "â° Run completed or timed out"
        
        # ä¿å­˜åŸºç¡€æ€§èƒ½ä¿¡æ¯
        echo "ğŸ–¥ï¸ System Info:" > benchmark.txt
        lscpu | grep "Model name" >> benchmark.txt
        echo "CPU Cores: $(nproc)" >> benchmark.txt
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')" >> benchmark.txt
        
        echo "ğŸ“ˆ Benchmark completed at $(date)" >> benchmark.txt
        cat benchmark.txt
    
    - name: ğŸ® Run Visual Game
      if: matrix.run-type == 'visual'
      run: |
        echo "ğŸ¨ Running Visual 2048 Game..."
        # æœ€å¤šè¿è¡Œ1000æ­¥æˆ–10åˆ†é’Ÿ
        timeout 600 ./2048_ai | head -1000
        
        echo "âœ… Visual run completed"
    
    - name: ğŸ“¦ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: 2048-ai-results-${{ matrix.run-type }}
        path: |
          benchmark.txt
          2048_ai
        retention-days: 30
    
    - name: ğŸ“ˆ Performance Report
      run: |
        echo "ğŸ Performance Summary"
        echo "======================"
        echo "Run Type: ${{ matrix.run-type }}"
        echo "OS: Ubuntu Latest"
        echo "CPU: $(nproc) cores"
        echo "Build: Optimized with -O3 and native arch"
        echo "Completed at: $(date)"

  advanced-test:
    runs-on: ubuntu-latest
    needs: build-and-run
    if: always()
    
    steps:
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ğŸ“‹ Test Results
      run: |
        echo "ğŸ§ª Advanced Testing Results"
        echo "==========================="
        find artifacts -name "*.txt" -exec cat {} \;
        
        echo "âœ… All tests completed successfully"
